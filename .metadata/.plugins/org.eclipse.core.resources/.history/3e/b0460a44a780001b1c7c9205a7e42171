package ma.youcode.api.controller;

import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;

import ma.youcode.api.model.Appointment;
import ma.youcode.api.model.User;
import ma.youcode.api.service.AppointmentService;
import ma.youcode.api.service.UserService;
import netscape.javascript.JSObject;

@Controller
//@RequestMapping(value = "/user")
public class UserController {
	@Autowired
	private UserService userService;
	
	@Autowired
	private AppointmentService appointmentService;

	private String isSignedUp = null;
	private String isLoggedIn = null;
	private User currentUser = null;
	private String isAppointmentMade = null;

	@GetMapping(value = "/")
	public String home(Model model) {
		List<Appointment> appointmentsList = appointmentService.getAllAppointments();
		
		model.addAttribute("isSignedUp", isSignedUp);
		model.addAttribute("isLoggedIn", isLoggedIn);
		model.addAttribute("isAppointmentMade", isAppointmentMade);

		model.addAttribute("appointments", appointmentsList);
		
		return "home";
	}

	@PostMapping(value = "/signup")
	public String signup(User user) {

		int affectedRow = userService.saveUser(user);

		if (affectedRow > 0) {
			isSignedUp = "true";
		} else {
			isSignedUp = "false";
		}

		return "redirect:/";
	}
	
	@PostMapping(value = "/login")
	public String login(User user) {
		
		User theUser = userService.login(user.getEmail(), user.getPassword());

		if (theUser != null) {
			isLoggedIn = "true";
			this.currentUser = theUser;
		} else {
			isLoggedIn = "false";
		}

		return "redirect:/";
	}

	@GetMapping(value = "/logout")
	public String logout(HttpServletRequest request) {
		HttpSession httpSession = request.getSession();
		httpSession.invalidate();
		
		isSignedUp = null;
		isLoggedIn = null;
		isAppointmentMade = null;
		
		return "redirect:/";
	}
	
	@PostMapping(value = "/appointment")
	public String makeAppointment(Appointment appointment) {
		String getIdFromDate = appointment.getAppointmentDate();
		String strId = getIdFromDate.split(",")[1];
		int id = Integer.parseInt(strId.trim());
		
		
		System.out.println("ID: " + id);
		System.out.println("appointment: " + appointment);

		if (currentUser != null && appointment != null) {
			int affectedRow = userService.makeAppointment(id);
			System.out.println("Current User: " + currentUser);
			
			if (affectedRow > 0) {
				isAppointmentMade = "true";
			} else {
				isAppointmentMade = "false";
			}
			
		}else {
			isAppointmentMade = "false";
		}
		
		return "redirect:/";
	}

}